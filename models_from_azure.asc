MODELS_FROM_AZURE

PROCEDURE global MODELS_FROM_AZURE
{
	CC "CoreUI" MODEL_SELECT_BOX without-models mgroup-sel title:"Select a target modelgroup for the IoT Scenario Model PSM"
    IF (endbutton != "ok") {
        EXIT
    }
    CC "Core" GET_MODEL_BASENAME modelid:(modelid)
    CC "AdoScript" EDITFIELD title:("Insert new model name for the model imported from Azure..." + basename) caption:("~Modelname:")
    IF (ecode != 0) {
    	EXIT
	}
    CC "Core" CREATE_MODEL modeltype:("IoT Scenario") modelname:(text) version:"" mgroups:(mgroupids)

    IF (ecode = 0) {
    	SET a_dstmodelid:(modelid)
    } ELSIF (ecode = 40) {
    	CC "AdoScript" ERRORBOX ("A model with the same name already exists!") ok
        EXIT
	} ELSE {
    	CC "AdoScript" ERRORBOX ("An error occured creating the new model: " + errtext) ok
        EXIT
    }

	CC "Modeling" SET_VIEW_MODE modelid:(a_dstmodelid) mode-name:"PSM"
	CC "Modeling" OPEN modelids:(a_dstmodelid)


	# Get application name
	SETL applicationURL: ("")
	CC "AdoScript" EDITFIELD title:"Azure's application name" caption:"Application name:" text:"MyAzureApplication"
	IF (ecode != 0) {
        EXIT
    }
    SET applicationURL: (text)

	# Get API token TODO poi ripristinare
	SETL headers: (map())
	#CC "AdoScript" EDITFIELD title:"Azure's API token" caption:"API token (find it at 'Permissions>API tokens'):" text:"API token"
	#IF (ecode != 0) {
    #    EXIT
    #}
	#SET apiToken:(text)
	SET apiToken:("SharedAccessSignature sr=368b8d24-e2f2-4454-844b-93d29bc1dde6&sig=NZqVcdPZH9NFQkuQBvz65txwipMrhJ%2FrUfQBe%2BOk%2FBc%3D&skn=genzo&se=1708081185061")
	SETL headers["Authorization"]: (apiToken)
	#SETL headers["Content-Type"]:("application/json;odata=verbose") todo forse serve solo per le PUT
 
	# GET DEVICE LIST
	SETL url:("https://"+applicationURL+".azureiotcentral.com/api/devices?api-version=2022-07-31")
	HTTP_SEND_REQUEST(url) str_method:("GET") map_reqheaders:(headers) str_reqbody:("") val_respcode:respstat map_respheaders:respheaders str_respbody:str_respbody

	# For each device in the device list create new objects
	SET mapRespBody: (fromJson(str_respbody))

	SETL devicesArray:(mapRespBody["value"])

	SETL objPosX:(2cm)
	SETL objPosY:(2cm)

	FOR i from:0 to:(LEN devicesArray-1) {
		# todo rimuovere CC "AdoScript" INFOBOX("devicesArray[i]: " + STR devicesArray[i])
		SET deviceName: (devicesArray[i]["id"])
		CC "Core" GET_CLASS_ID classname:("device")
		CC "Core" CREATE_OBJ modelid:(a_dstmodelid) classid:(classid)
		SETL newobjid:(objid)
		CC "Core" SET_ATTR_VAL objid:(newobjid) attrname:("name") val:(deviceName)
		CC "Modeling" SET_OBJ_POS objid:(newobjid) x:(objPosX) y:(objPosY)
		SETL objPosY:(objPosY+5cm)
	}

	# GET DEVICE TEMPLATE LIST

	# GET DASHBOARD LIST

	

}